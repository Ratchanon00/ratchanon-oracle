<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUSTBOY | LUMINOUS ZEN 4.0</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@200;400;600&display=swap');

        :root {
            --bg-light: #f5f7fa;
            --accent-primary: #1a1a1a;
            --accent-gold: #b08d57;
            --text-main: #2d3436;
            --glass-border: rgba(0, 0, 0, 0.05);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --shadow-soft: 0 20px 60px rgba(0, 0, 0, 0.05);
        }

        body {
            margin: 0;
            background-color: var(--bg-light);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            transition: background 1s ease;
        }

        canvas {
            display: block;
        }

        #ui-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 60px;
            z-index: 10;
        }

        .luminous-panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(30px);
            padding: 40px;
            pointer-events: auto;
            border-radius: 30px;
            box-shadow: var(--shadow-soft);
            transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .brand {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.8rem;
            letter-spacing: 0.5em;
            color: var(--accent-gold);
            margin-bottom: 40px;
            text-transform: uppercase;
        }

        .main-val-group {
            margin-bottom: 50px;
        }

        .label {
            font-size: 0.65rem;
            opacity: 0.4;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .big-val {
            font-family: 'Outfit', sans-serif;
            font-size: 4rem;
            font-weight: 200;
            line-height: 0.9;
            color: var(--accent-primary);
        }

        .grid-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid rgba(0, 0, 0, 0.03);
        }

        #device-list {
            margin-top: 40px;
            height: 320px;
            overflow-y: auto;
            scrollbar-width: none;
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }

        .device-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.02);
            font-size: 0.85rem;
            transition: 0.3s;
        }

        .device-row:hover {
            color: var(--accent-gold);
            transform: translateX(5px);
        }

        #console-luminous {
            font-size: 9px;
            color: rgba(0, 0, 0, 0.2);
            max-width: 350px;
            line-height: 2;
            letter-spacing: 0.1em;
        }

        #nav-luminous {
            display: flex;
            gap: 50px;
            pointer-events: auto;
        }

        .nav-item {
            color: rgba(0, 0, 0, 0.3);
            text-decoration: none;
            font-size: 0.75rem;
            letter-spacing: 0.2em;
            transition: 0.3s;
            font-weight: 500;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--accent-primary);
        }

        .nav-item.active {
            position: relative;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent-gold);
        }

        .loading {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: 1.5s cubic-bezier(0.7, 0, 0.3, 1);
        }

        .loading-logo {
            font-family: 'Outfit', sans-serif;
            font-weight: 400;
            font-size: 2rem;
            letter-spacing: 1em;
            color: var(--accent-primary);
            animation: breathe 3s infinite ease-in-out;
            padding-left: 1em;
            /* Offset for tracking center */
        }

        @keyframes breathe {

            0%,
            100% {
                opacity: 0.2;
                letter-spacing: 1.2em;
                filter: blur(2px);
            }

            50% {
                opacity: 1;
                letter-spacing: 0.8em;
                filter: blur(0);
            }
        }
    </style>
</head>

<body>
    <div id="loading" class="loading">
        <div class="loading-logo">DUSTBOY</div>
        <div style="font-size: 8px; margin-top: 30px; opacity: 0.2; letter-spacing: 5px;">ARCHITECTURE 4.0 // LUMINOUS
        </div>
    </div>

    <div id="ui-overlay">
        <div class="header">
            <!-- Sensor Intelligence Panel -->
            <div class="luminous-panel" style="width: 420px;">
                <div class="brand">Sensor Intelligence</div>

                <div class="main-val-group">
                    <div class="label">Regional Average PM2.5</div>
                    <div id="avg-pm" class="big-val">0.0</div>
                </div>

                <div class="grid-stats">
                    <div class="stat-box">
                        <div class="label">System Units</div>
                        <div id="total-st" style="font-size: 1.4rem; font-weight: 400;">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Uptime Sync</div>
                        <div id="uptime" style="font-size: 1.4rem; font-weight: 400;">00:00:00</div>
                    </div>
                </div>

                <div id="device-list"></div>
            </div>

            <!-- Peak Analytics Panel -->
            <div class="luminous-panel" style="width: 440px;">
                <div class="brand">Analytics Stream</div>

                <div class="main-val-group">
                    <div class="label">Peak Concentration</div>
                    <div id="max-pm" class="big-val" style="color: var(--accent-gold);">0.0</div>
                </div>

                <div style="margin-top: 50px; height: 200px; padding: 10px;">
                    <canvas id="lumeChart"></canvas>
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div id="console-luminous">
                [CORE] Luminous v4.0 Active<br>
                [WSS] Secure WebSocket Uplink Ready<br>
                [MODE] High-Clarity Visualization
            </div>

            <div id="nav-luminous">
                <a href="index.html" class="nav-item">BASE_MAP</a>
                <a href="travel-3d.html" class="nav-item">TRAVEL_3D</a>
                <a href="dustboy-3d.html" class="nav-item active">INTELLIGENCE</a>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- Sophisticated Utils ---
        const Lume = {
            expStep: (c, t, s, dt) => t + (c - t) * Math.exp(-s * dt),
            noise: (p) => Math.abs(Math.sin(p) * 43758.5453 % 1)
        };

        // --- Scenario Build ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf5f7fa);
        scene.fog = new THREE.Fog(0xf5f7fa, 500, 1500);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 5000);
        camera.position.set(400, 300, 800);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.3;

        // Post-Processing
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.4, 0.4, 0.9);
        composer.addPass(bloom);

        // Advanced Lighting
        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        const sun = new THREE.DirectionalLight(0xffffff, 1.5);
        sun.position.set(500, 1000, 500);
        sun.castShadow = true;
        scene.add(sun);

        const rim = new THREE.PointLight(0xb08d57, 10, 2000);
        rim.position.set(-500, 200, -500);
        scene.add(rim);

        // Ground Structure
        const wallGeo = new THREE.CylinderGeometry(1000, 1000, 2, 64);
        const wallMat = new THREE.MeshPhongMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 });
        const ground = new THREE.Mesh(wallGeo, wallMat);
        ground.position.y = -200;
        scene.add(ground);

        const meshGroup = new THREE.Group();
        scene.add(meshGroup);

        // --- Data Logic ---
        const stations = new Map();
        const startTime = Date.now();
        let lastFrame = performance.now();

        function createLumeNode(pm) {
            const group = new THREE.Group();

            // Sculptural Orb
            const mat = new THREE.MeshStandardMaterial({
                color: 0xffffff, metalness: 0.1, roughness: 0.1,
                transparent: true, opacity: 0.8
            });

            const sphere = new THREE.Mesh(new THREE.SphereGeometry(8, 64, 64), mat);
            sphere.castShadow = true;

            // Halo Ring
            const ring = new THREE.Mesh(
                new THREE.TorusGeometry(18, 0.2, 16, 128),
                new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.05 })
            );
            ring.rotation.x = Math.PI / 2;

            group.add(sphere, ring);
            group.position.set((Math.random() - 0.5) * 1500, (Math.random() - 0.5) * 400, (Math.random() - 0.5) * 1200);
            scene.add(group);
            return group;
        }

        const client = mqtt.connect('wss://dustboy-wss-bridge.laris.workers.dev/mqtt');
        client.on('connect', () => {
            setTimeout(() => { document.getElementById('loading').style.opacity = '0'; setTimeout(() => document.getElementById('loading').style.display = 'none', 1500); }, 2500);
            client.subscribe('DUSTBOY/+/+/+/status');
        });

        client.on('message', (topic, msg) => {
            try {
                const parts = topic.split('/');
                const raw = JSON.parse(msg.toString());
                const isT = parts[1] === 'Model-T';
                let pm = isT ? raw.pm2_5 : (raw.d?.pm2_5 || raw.pm2_5);
                let name = isT ? (raw.nickname || parts[2]) : (raw.d?.myName || raw.myName || parts[3]);

                if (!stations.has(topic)) {
                    stations.set(topic, {
                        name, targetPM: pm, currentPM: pm,
                        node: createLumeNode(pm), offset: Math.random() * 5000
                    });
                } else {
                    stations.get(topic).targetPM = pm;
                }
                updateUI();
            } catch (e) { }
        });

        function updateUI() {
            let total = 0, max = 0;
            const list = document.getElementById('device-list');
            list.innerHTML = '';

            stations.forEach(st => {
                total += st.currentPM;
                if (st.currentPM > max) max = st.currentPM;
                const row = document.createElement('div');
                row.className = 'device-row';
                row.innerHTML = `<span>${st.name}</span><span style="font-weight:600; opacity:0.8">${st.currentPM.toFixed(1)}</span>`;
                list.appendChild(row);
            });

            const avg = total / (stations.size || 1);
            document.getElementById('avg-pm').innerText = avg.toFixed(1);
            document.getElementById('total-st').innerText = stations.size;
            document.getElementById('max-pm').innerText = max.toFixed(1);
            updateLumeChart(avg);
        }

        // --- Chart ---
        const lumeChart = new Chart(document.getElementById('lumeChart'), {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#b08d57', borderWidth: 1.5, tension: 0.5, pointRadius: 0, fill: false }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, scales: { x: { display: false }, y: { grid: { color: 'rgba(0,0,0,0.03)' }, ticks: { font: { size: 9 }, color: '#aaa', display: false } } } }
        });
        function updateLumeChart(val) {
            if (lumeChart.data.labels.length > 60) { lumeChart.data.labels.shift(); lumeChart.data.datasets[0].data.shift(); }
            lumeChart.data.labels.push(''); lumeChart.data.datasets[0].data.push(val);
            lumeChart.update('none');
        }

        // --- Animate ---
        function animate() {
            requestAnimationFrame(animate);
            const now = performance.now();
            const dt = (now - lastFrame) / 1000;
            lastFrame = now;
            const time = now * 0.001;

            controls.update();

            stations.forEach(st => {
                st.currentPM = Lume.expStep(st.currentPM, st.targetPM, 1, dt);

                // Float
                st.node.position.y += Math.sin(time * 0.5 + st.offset) * 0.15;

                // Advanced Color Dynamics (Ethereal Neutral)
                const p = Math.min(1, st.currentPM / 100);
                const baseColor = new THREE.Color(0xffffff);
                const dangerColor = new THREE.Color(0xb08d57); // Warm Gold for alert
                baseColor.lerp(dangerColor, p);

                st.node.children[0].material.color.lerp(baseColor, 0.05);
                st.node.children[0].material.emissive.set(baseColor);
                st.node.children[0].material.emissiveIntensity = p * 0.3;

                const s = 1 + (st.currentPM / 120);
                st.node.scale.lerp(new THREE.Vector3(s, s, s), 0.05);
            });

            // Sculptural Connectivity
            meshGroup.clear();
            const arr = Array.from(stations.values());
            for (let i = 0; i < arr.length; i++) {
                for (let j = i + 1; j < arr.length; j++) {
                    const d = arr[i].node.position.distanceTo(arr[j].node.position);
                    if (d < 400) {
                        const geo = new THREE.BufferGeometry().setFromPoints([arr[i].node.position, arr[j].node.position]);
                        const mat = new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: (1 - d / 400) * 0.03 });
                        meshGroup.add(new THREE.Line(geo, mat));
                    }
                }
            }

            composer.render();
        }
        animate();

        setInterval(() => {
            const d = Date.now() - startTime;
            document.getElementById('uptime').innerText = new Date(d).toISOString().substr(11, 8);
        }, 1000);

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>
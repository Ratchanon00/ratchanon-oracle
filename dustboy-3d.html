<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUSTBOY | EXTREME HUD 3D</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap');

        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff00ea;
            --bg-dark: #000210;
        }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: white;
            font-family: 'Orbitron', sans-serif;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        /* Slanted HUD Borders */
        .panel {
            background: rgba(10, 15, 40, 0.7);
            border: 1px solid var(--neon-blue);
            backdrop-filter: blur(15px);
            padding: 25px;
            pointer-events: auto;
            clip-path: polygon(0% 0%, 90% 0%, 100% 10%, 100% 100%, 10% 100%, 0% 90%);
            box-shadow: inset 0 0 20px rgba(0, 242, 255, 0.2);
            position: relative;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 5px;
            background: var(--neon-blue);
        }

        #ui-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .title {
            color: var(--neon-blue);
            font-size: 1.5rem;
            letter-spacing: 5px;
            text-shadow: 0 0 10px var(--neon-blue);
            margin-bottom: 20px;
        }

        .stat-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stat-card {
            border-left: 2px solid var(--neon-pink);
            padding-left: 15px;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--neon-pink);
            opacity: 0.8;
        }

        .stat-val {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .device-scroll {
            margin-top: 20px;
            height: 300px;
            overflow-y: auto;
            scrollbar-width: none;
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 242, 255, 0.1);
        }

        #log-console {
            width: 450px;
            height: 150px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px dashed var(--neon-blue);
            padding: 10px;
            font-family: monospace;
            font-size: 10px;
            color: #00ffaa;
            overflow: hidden;
            pointer-events: auto;
        }

        /* Glitch Animation */
        .glitch {
            animation: glitch 1s infinite alternate;
        }

        @keyframes glitch {
            0% {
                transform: translate(0);
                text-shadow: 2px 2px var(--neon-pink);
            }

            100% {
                transform: translate(-1px, 1px);
                text-shadow: -2px -2px var(--neon-blue);
            }
        }

        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
        }

        .orbit-loader {
            width: 80px;
            height: 80px;
            border: 2px solid transparent;
            border-top: 2px solid var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        #navigation-footer {
            display: flex;
            gap: 20px;
            justify-content: center;
            pointer-events: auto;
        }

        .nav-btn {
            padding: 8px 16px;
            border: 1px solid var(--neon-blue);
            background: rgba(0, 242, 255, 0.05);
            color: var(--neon-blue);
            text-decoration: none;
            font-size: 0.8rem;
            transition: 0.3s;
            backdrop-filter: blur(5px);
        }

        .nav-btn:hover {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 20px var(--neon-blue);
        }

        .active {
            border-color: var(--neon-pink);
            color: var(--neon-pink);
        }
    </style>
</head>

<body>
    <div id="loading" class="loading-screen">
        <div class="orbit-loader"></div>
        <div style="margin-top: 20px; color: var(--neon-blue); letter-spacing: 5px;">INITIATING DUSTBOY CORE...</div>
        <div id="loading-progress" style="font-size: 10px; margin-top: 10px;">ESTABLISHING UPLINK [0%]</div>
    </div>

    <div id="ui-overlay">
        <!-- TOP SECTION -->
        <div class="header-section">
            <div class="hud-panel" style="width: 350px;">
                <div class="title">üõ∞Ô∏è SENSOR NETWORK</div>
                <div class="stat-box" style="margin-bottom: 15px;">
                    <div class="stat-label">SYSTEM UPTIME</div>
                    <div id="uptime" class="stat-value">00:00:00</div>
                </div>
                <div class="data-grid">
                    <div class="stat-box">
                        <div class="stat-label">TOTAL UNITS</div>
                        <div id="total-st" class="stat-value">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">AVG PM2.5</div>
                        <div id="avg-pm" class="stat-value">0.0</div>
                    </div>
                </div>
                <div class="device-list" id="device-list">
                    <!-- Devices injected here -->
                </div>
            </div>

            <div class="hud-panel" style="width: 350px; border-left: 0; border-right: 4px solid var(--neon-pink);">
                <div class="title" style="color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink);">‚ò¢Ô∏è HAZARD
                    ALERT</div>
                <div class="stat-box">
                    <div class="stat-label">PEAK CONCENTRATION</div>
                    <div id="max-pm" class="stat-value" style="color: var(--neon-red);">0.0</div>
                </div>
                <div id="max-st-name"
                    style="font-size: 0.7rem; color: var(--neon-pink); text-align: center; margin-top: 5px; opacity: 0.8;">
                    -</div>

                <div style="margin-top: 20px; height: 180px;">
                    <canvas id="miniChart"></canvas>
                </div>
            </div>
        </div>

        <!-- BOTTOM SECTION -->
        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div class="hud-panel" style="width: 400px; border-left: 2px solid #0f0;">
                <div class="title" style="font-size: 0.9rem; color: #0f0; text-shadow: none;">‚ö° REAL-TIME STREAM</div>
                <div id="log-panel">
                    Initializing encryption...<br>
                    Handshake with Cloud-WSS...<br>
                </div>
            </div>

            <div id="navigation-footer">
                <a href="index.html" class="nav-btn">üåè 2D BASE</a>
                <a href="travel-3d.html" class="nav-btn">üöÇ NATURE-CORE</a>
                <a href="dustboy-3d.html" class="nav-btn active">üõ∞Ô∏è DUST-HUD</a>
            </div>
        </div>
    </div>

    <!-- THREE.JS IMPORTS -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';

        // --- Config ---
        const MQTT_URL = 'wss://dustboy-wss-bridge.laris.workers.dev/mqtt';
        const TOPIC = 'DUSTBOY/+/+/+/status';

        // --- State ---
        const stations = new Map();
        let startTime = Date.now();

        // --- Scene Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 4000);
        camera.position.set(0, 100, 300);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.3;

        // Neural Mesh (Connections)
        const lineMaterial = new THREE.LineBasicMaterial({ color: 0x00f2ff, transparent: true, opacity: 0.05 });
        const lineGroup = new THREE.Group();
        scene.add(lineGroup);

        // Env
        const hexGrid = new THREE.PolarGridHelper(500, 16, 8, 64, 0x00f2ff, 0x001122);
        hexGrid.position.y = -100;
        scene.add(hexGrid);

        const light = new THREE.DirectionalLight(0xffffff, 2);
        light.position.set(1, 1, 1);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x002244, 2));

        // --- Post Processing ---
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));

        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloom.threshold = 0.1; bloom.strength = 1.0; bloom.radius = 0.5;
        composer.addPass(bloom);

        // --- Nodes Management ---
        function createHoloNode(st) {
            const group = new THREE.Group();

            // Central Data Core
            const coreGeo = new THREE.IcosahedronGeometry(3, 1);
            const coreMat = new THREE.MeshPhongMaterial({
                color: getPMColorHex(st.pm25),
                emissive: getPMColorHex(st.pm25),
                emissiveIntensity: 5,
                wireframe: false
            });
            const core = new THREE.Mesh(coreGeo, coreMat);

            // Outer Shield
            const shieldGeo = new THREE.SphereGeometry(6, 16, 16);
            const shieldMat = new THREE.MeshBasicMaterial({ color: 0x00f2ff, wireframe: true, transparent: true, opacity: 0.1 });
            const shield = new THREE.Mesh(shieldGeo, shieldMat);

            // Label Sprite (Mock)
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff'; ctx.font = 'Bold 40px Rajdhani';
            ctx.fillText(st.name.toUpperCase(), 0, 80);
            const texture = new THREE.CanvasTexture(canvas);
            const labelSprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture, transparent: true }));
            labelSprite.position.y = 12; labelSprite.scale.set(15, 7, 1);

            group.add(core, shield, labelSprite);
            group.position.set((Math.random() - 0.5) * 300, (Math.random() - 0.5) * 150, (Math.random() - 0.5) * 200);
            scene.add(group);
            return group;
        }

        function getPMColorHex(pm) {
            if (pm <= 25) return 0x3fb950;
            if (pm <= 50) return 0xfbbf24;
            if (pm <= 100) return 0xf87171;
            return 0xc084fc;
        }

        // --- MQTT & Data ---
        const client = mqtt.connect(MQTT_URL);

        client.on('connect', () => {
            document.getElementById('loading-progress').innerText = 'LINK ESTABLISHED [100%]';
            setTimeout(() => document.getElementById('loading').style.display = 'none', 1000);
            client.subscribe(TOPIC);
        });

        client.on('message', (topic, message) => {
            const data = parseDustBoy(topic, message.toString());
            if (!data) return;

            if (!stations.has(topic)) {
                stations.set(topic, { ...data, node: createHoloNode(data) });
            } else {
                const st = stations.get(topic);
                Object.assign(st, data);
                st.node.children[0].material.color.setHex(getPMColorHex(data.pm25));
                st.node.children[0].material.emissive.setHex(getPMColorHex(data.pm25));
            }
            updateUI();
            logStream(`RECV CHANNEL [${topic.split('/').pop()}]: PM2.5=${data.pm25}`);
        });

        function parseDustBoy(topic, raw) {
            try {
                const obj = JSON.parse(raw);
                const parts = topic.split('/');
                const isModelT = parts[1] === 'Model-T';
                let pm25, name;
                if (isModelT) {
                    pm25 = obj.pm2_5; name = obj.nickname || parts[2];
                } else {
                    const d = obj.d || obj;
                    pm25 = d.pm2_5; name = d.myName || parts[3];
                }
                return { name, pm25 };
            } catch (e) { return null; }
        }

        // --- UI Utils ---
        function updateUI() {
            let total = 0, maxPm = 0, maxName = '-';
            const list = document.getElementById('device-list');
            list.innerHTML = '';

            stations.forEach((st, id) => {
                total += parseFloat(st.pm25);
                if (st.pm25 > maxPm) { maxPm = st.pm25; maxName = st.name; }

                const item = document.createElement('div');
                item.className = 'device-item';
                const color = '#' + getPMColorHex(st.pm25).toString(16).padStart(6, '0');
                item.innerHTML = `
                    <span><span class="aqi-dot" style="color:${color}; background:${color}"></span> ${st.name}</span>
                    <span style="color:${color}; font-weight:bold">${st.pm25}</span>
                `;
                list.appendChild(item);
            });

            const avg = stations.size > 0 ? (total / stations.size).toFixed(1) : 0;
            document.getElementById('total-st').innerText = stations.size;
            document.getElementById('avg-pm').innerText = avg;
            document.getElementById('max-pm').innerText = maxPm;
            document.getElementById('max-st-name').innerText = maxName;

            updateChart(avg);
        }

        function logStream(msg) {
            const panel = document.getElementById('log-panel');
            const row = document.createElement('div');
            row.innerHTML = `> [${new Date().toLocaleTimeString()}] ${msg}`;
            panel.prepend(row);
            if (panel.children.length > 8) panel.removeChild(panel.lastChild);
        }

        // --- Timer ---
        setInterval(() => {
            const diff = Date.now() - startTime;
            const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
            const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
            document.getElementById('uptime').innerText = `${h}:${m}:${s}`;
        }, 1000);

        // --- Chart ---
        const ctx = document.getElementById('miniChart');
        const chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#00f2ff', borderWeight: 1, tension: 0.4, fill: true, backgroundColor: 'rgba(0, 242, 255, 0.1)' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#222' }, ticks: { color: '#666', font: { size: 9 } } } } }
        });

        function updateChart(val) {
            if (chart.data.labels.length > 20) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
            chart.data.labels.push(''); chart.data.datasets[0].data.push(val);
            chart.update('none');
        }

        // --- Main Loop ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // Animate Nodes
            stations.forEach(st => {
                st.node.rotation.y += 0.02;
                st.node.children[1].rotation.x += 0.01; // Shield rotate
                const s = 1 + Math.sin(Date.now() * 0.005) * 0.1;
                st.node.scale.set(s, s, s);
            });

            composer.render();
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>
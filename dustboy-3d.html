<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUSTBOY | ZEN FUTURISM 3.0</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@300;500;700&display=swap');

        :root {
            --bg-deep: #0a0a0b;
            --accent-gold: #c5a059;
            --accent-cyan: #00e5ff;
            --text-main: #f8f9fa;
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(255, 255, 255, 0.02);
        }

        body {
            margin: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            letter-spacing: -0.01em;
        }

        canvas {
            display: block;
            filter: contrast(110%) brightness(105%);
        }

        #ui-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 50px;
            z-index: 10;
        }

        .minimal-panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(25px);
            padding: 30px;
            pointer-events: auto;
            border-radius: 20px;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.5);
            transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .brand {
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 0.4em;
            color: var(--accent-gold);
            margin-bottom: 30px;
        }

        .main-val-group {
            margin-bottom: 40px;
        }

        .label {
            font-size: 0.65rem;
            opacity: 0.4;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .big-val {
            font-family: 'Outfit', sans-serif;
            font-size: 3rem;
            font-weight: 300;
            line-height: 1;
        }

        .grid-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            border-top: 1px solid var(--glass-border);
            pt: 20px;
            margin-top: 20px;
            padding-top: 20px;
        }

        #device-list {
            margin-top: 30px;
            height: 320px;
            overflow-y: auto;
            scrollbar-width: none;
            mask-image: linear-gradient(to bottom, black 70%, transparent 100%);
        }

        .device-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 0.8rem;
            transition: 0.3s;
        }

        .device-row:hover {
            color: var(--accent-cyan);
        }

        .status-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 12px;
        }

        #console-minimal {
            font-family: 'Inter', sans-serif;
            font-size: 9px;
            color: rgba(255, 255, 255, 0.3);
            max-width: 300px;
            line-height: 1.6;
        }

        #nav-minimal {
            display: flex;
            gap: 40px;
            pointer-events: auto;
        }

        .nav-item {
            color: rgba(255, 255, 255, 0.4);
            text-decoration: none;
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            transition: 0.3s;
            position: relative;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--text-main);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--accent-gold);
        }

        .loading {
            position: fixed;
            inset: 0;
            background: var(--bg-deep);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: 1s ease-in-out;
        }

        .loading-logo {
            font-family: 'Outfit', sans-serif;
            font-weight: 300;
            font-size: 1.5rem;
            letter-spacing: 0.8em;
            color: var(--accent-gold);
            animation: pulse-luxury 2s infinite ease-in-out;
        }

        @keyframes pulse-luxury {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(0.98);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <div id="loading" class="loading">
        <div class="loading-logo">DUSTBOY PRO</div>
        <div style="font-size: 8px; margin-top: 20px; opacity: 0.3; letter-spacing: 2px;">CALIBRATING NEURAL
            ARCHITECTURE</div>
    </div>

    <div id="ui-overlay">
        <div class="header">
            <!-- Left Data Panel -->
            <div class="minimal-panel" style="width: 380px;">
                <div class="brand">SYSTEM STATUS</div>

                <div class="main-val-group">
                    <div class="label">Network Average PM2.5</div>
                    <div id="avg-pm" class="big-val">0.0</div>
                </div>

                <div class="grid-stats">
                    <div class="stat-box">
                        <div class="label">Active Nodes</div>
                        <div id="total-st" style="font-size: 1.2rem; font-weight: 500;">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Uptime</div>
                        <div id="uptime" style="font-size: 1.2rem; font-weight: 500;">00:00:00</div>
                    </div>
                </div>

                <div id="device-list"></div>
            </div>

            <!-- Right Analytics Panel -->
            <div class="minimal-panel" style="width: 400px; padding: 40px;">
                <div class="brand">PEAK ANALYTICS</div>

                <div class="main-val-group">
                    <div class="label">Highest Recorded</div>
                    <div id="max-pm" class="big-val" style="color: var(--accent-gold);">0.0</div>
                </div>

                <div style="margin-top: 40px; height: 180px;">
                    <canvas id="luxChart"></canvas>
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div id="console-minimal">
                [STORAGE] ZEN_CORE_V3_INITIATED<br>
                [UPLINK] CONNECTED_TO_SECURE_WSS<br>
                [MODE] MINIMALIST_PREMIUM_ACTIVE
            </div>

            <div id="nav-minimal">
                <a href="index.html" class="nav-item">BASE MAP</a>
                <a href="travel-3d.html" class="nav-item">ETHEREAL 3D</a>
                <a href="dustboy-3d.html" class="nav-item active">ZEN DASHBOARD</a>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- Core Algorithm (Klak Inspired) ---
        const Zen = {
            lerp: (a, b, t) => a + (b - a) * t,
            expStep: (c, t, s, dt) => t + (c - t) * Math.exp(-s * dt),
            noise: (p) => {
                const i = Math.floor(p);
                const f = p - i;
                const u = f * f * (3 - 2 * f);
                const hash = (n) => Math.abs(Math.sin(n) * 43758.5453 % 1);
                return Zen.lerp(hash(i), hash(i + 1), u);
            }
        };

        // --- Init Scene ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x0a0a0b, 0.002);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 5000);
        camera.position.set(0, 200, 600);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.2;

        // Post-Processing (Premium Bloom)
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.8, 0.4, 0.95);
        bloom.threshold = 0.5; bloom.strength = 0.6; bloom.radius = 1;
        composer.addPass(bloom);

        // Env
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const spot = new THREE.PointLight(0xffffff, 500000);
        spot.position.set(200, 500, 200);
        scene.add(spot);

        // Ethereal Starfield
        const starGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(5000 * 3);
        for (let i = 0; i < 5000 * 3; i++) starPos[i] = (Math.random() - 0.5) * 4000;
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 1, transparent: true, opacity: 0.1 });
        scene.add(new THREE.Points(starGeo, starMat));

        const meshGroup = new THREE.Group();
        scene.add(meshGroup);

        // --- Data Logic ---
        const stations = new Map();
        const startTime = Date.now();
        let lastFrame = performance.now();

        function createZenNode(st) {
            const group = new THREE.Group();

            const mat = new THREE.MeshPhongMaterial({
                color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 0.2,
                transparent: true, opacity: 0.4, shininess: 100
            });

            const sphere = new THREE.Mesh(new THREE.SphereGeometry(6, 32, 32), mat);
            const ring = new THREE.Mesh(new THREE.TorusGeometry(12, 0.1, 16, 100), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.05 }));
            ring.rotation.x = Math.PI / 2;

            group.add(sphere, ring);
            group.position.set((Math.random() - 0.5) * 1200, (Math.random() - 0.5) * 400, (Math.random() - 0.5) * 1000);
            scene.add(group);
            return group;
        }

        const client = mqtt.connect('wss://dustboy-wss-bridge.laris.workers.dev/mqtt');
        client.on('connect', () => {
            setTimeout(() => { document.getElementById('loading').style.opacity = '0'; setTimeout(() => document.getElementById('loading').style.display = 'none', 1000); }, 2000);
            client.subscribe('DUSTBOY/+/+/+/status');
        });

        client.on('message', (topic, msg) => {
            try {
                const parts = topic.split('/');
                const raw = JSON.parse(msg.toString());
                const isT = parts[1] === 'Model-T';
                let pm = isT ? raw.pm2_5 : (raw.d?.pm2_5 || raw.pm2_5);
                let name = isT ? (raw.nickname || parts[2]) : (raw.d?.myName || raw.myName || parts[3]);

                if (!stations.has(topic)) {
                    stations.set(topic, {
                        name, targetPM: pm, currentPM: pm,
                        node: createZenNode(pm), noiseOff: Math.random() * 1000
                    });
                } else {
                    stations.get(topic).targetPM = pm;
                }
                updateUI();
            } catch (e) { }
        });

        function updateUI() {
            let total = 0, max = 0;
            const list = document.getElementById('device-list');
            list.innerHTML = '';

            stations.forEach(st => {
                total += st.currentPM;
                if (st.currentPM > max) max = st.currentPM;
                const row = document.createElement('div');
                row.className = 'device-row';
                const opacity = Math.min(1, st.currentPM / 100) * 0.8 + 0.2;
                row.innerHTML = `<span>${st.name}</span><span style="opacity:${opacity}">${st.currentPM.toFixed(1)}</span>`;
                list.appendChild(row);
            });

            const avg = total / (stations.size || 1);
            document.getElementById('avg-pm').innerText = avg.toFixed(1);
            document.getElementById('total-st').innerText = stations.size;
            document.getElementById('max-pm').innerText = max.toFixed(1);
            updateLuxChart(avg);
        }

        // --- Chart ---
        const luxChart = new Chart(document.getElementById('luxChart'), {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#c5a059', borderWeight: 1, tension: 0.5, pointRadius: 0, fill: false }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { display: false } } } }
        });
        function updateLuxChart(val) {
            if (luxChart.data.labels.length > 50) { luxChart.data.labels.shift(); luxChart.data.datasets[0].data.shift(); }
            luxChart.data.labels.push(''); luxChart.data.datasets[0].data.push(val);
            luxChart.update('none');
        }

        // --- Animate ---
        function animate() {
            requestAnimationFrame(animate);
            const now = performance.now();
            const dt = (now - lastFrame) / 1000;
            lastFrame = now;
            const time = now * 0.001;

            controls.update();

            stations.forEach(st => {
                st.currentPM = Zen.expStep(st.currentPM, st.targetPM, 1.5, dt);

                // Organic Movement
                st.node.position.y += Math.sin(time + st.noiseOff) * 0.2;
                st.node.position.x += Math.cos(time * 0.5 + st.noiseOff) * 0.1;

                // Luxury Visuals
                const p = Math.min(1, st.currentPM / 100);
                const color = new THREE.Color().setHSL(0.55 - p * 0.5, 0.8, 0.6); // Cyan to Purple
                st.node.children[0].material.color.lerp(color, 0.05);
                st.node.children[0].material.emissive.lerp(color, 0.05);
                st.node.children[0].material.emissiveIntensity = p * 0.5 + 0.1;

                const s = 0.8 + (st.currentPM / 80);
                st.node.scale.set(s, s, s);
            });

            // Subtle Connections
            meshGroup.clear();
            const arr = Array.from(stations.values());
            for (let i = 0; i < arr.length; i++) {
                for (let j = i + 1; j < arr.length; j++) {
                    const d = arr[i].node.position.distanceTo(arr[j].node.position);
                    if (d < 250) {
                        const geo = new THREE.BufferGeometry().setFromPoints([arr[i].node.position, arr[j].node.position]);
                        const mat = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: (1 - d / 250) * 0.03 });
                        meshGroup.add(new THREE.Line(geo, mat));
                    }
                }
            }

            composer.render();
        }
        animate();

        setInterval(() => {
            const d = Date.now() - startTime;
            document.getElementById('uptime').innerText = new Date(d).toISOString().substr(11, 8);
        }, 1000);

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>
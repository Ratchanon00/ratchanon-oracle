<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Sky Flight: Chiang Mai to Phitsanulok</title>
    <style>
        body {
            margin: 0;
            background-color: #87CEEB;
            color: #333;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            overflow: hidden;
        }

        canvas {
            display: block;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #0288d1;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            min-width: 250px;
        }

        .label {
            color: #0288d1;
            font-weight: bold;
        }

        .meta {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 5px;
        }

        footer {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: #01579b;
            font-weight: bold;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        #loading {
            position: fixed;
            inset: 0;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            font-size: 18px;
            color: #0288d1;
        }
    </style>
</head>

<body>
    <div id="loading">‚úàÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏±‡∏ô‡πÄ‡∏ß‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡∏¢‡πÄ‡∏°‡∏Ü...</div>

    <div id="info">
        <h2 style="margin:0 0 10px 0; color: #0288d1; border-bottom: 2px solid #b3e5fc; padding-bottom: 5px;">‚úàÔ∏è Sky
            Oracle Flight</h2>
        <div>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏¥‡∏ô: <span id="place" class="label">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì...</span></div>
        <div class="meta">üåç ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á: <span id="address">-</span></div>
        <div style="margin-top: 10px;">üïí ‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏¥‡∏ô: <span id="time" class="label">-</span></div>
        <div>üîã ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: <span id="battery" class="label">-</span></div>
    </div>

    <footer>
        ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏î‡∏¢ <b style="color:#0288d1">BOB (‡∏ö‡πä‡∏≠‡∏ö)</b> ‚Äî Flight Visualization v3.0
    </footer>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const csvData = `device,model,battery,charging,lat,lon,accuracy,source,place,place_type,locality,address,updated
Nat iPhone12mini,iPhone 12 mini,80,NotCharging,18.464717,99.05675,5,GPS,,,Mueang Lamphun District,"Mueang Lamphun District, Lamphun 51000",2026-02-27 08:04:17
Nat iPhone12mini,iPhone 12 mini,80,NotCharging,18.456181,99.057669,14,GPS,,,Mueang Lamphun District,"Mueang Lamphun District, Lamphun 51000",2026-02-27 08:09:47
Nat iPhone12mini,iPhone 12 mini,78,NotCharging,18.456107,99.087873,15,GPS,,,Mae Tha District,"Mae Tha District, Lamphun 51140",2026-02-27 08:14:32
Nat iPhone12mini,iPhone 12 mini,77,NotCharging,18.461019,99.137354,14,GPS,,,Mae Tha District,"Mae Tha District, Lamphun 51140",2026-02-27 08:18:36
Nat iPhone12mini,iPhone 12 mini,69,NotCharging,18.392756,99.265662,51,GPS,,,Hang Chat District,"Hang Chat District, Lampang 52190",2026-02-27 09:01:45
Nat iPhone12mini,iPhone 12 mini,67,NotCharging,18.364852,99.287066,23,GPS,,,Hang Chat District,"Hang Chat District, Lampang 52190",2026-02-27 09:07:09
Nat iPhone12mini,iPhone 12 mini,67,NotCharging,18.37956,99.305078,9,GPS,,,Hang Chat District,"Hang Chat District, Lampang 52190",2026-02-27 09:11:23
Nat iPhone12mini,iPhone 12 mini,64,NotCharging,18.312283,99.413179,6,GPS,,,Mueang Lampang District,"Mueang Lampang District, Lampang 52100",2026-02-27 09:22:15
Nat iPhone12mini,iPhone 12 mini,63,NotCharging,18.281088,99.469882,8,GPS,,,Mueang Lampang District,"107 Rotfai Road, Sop Tui, Mueang Lampang District, Lampang 52100",2026-02-27 09:27:25
Nat iPhone12mini,iPhone 12 mini,62,NotCharging,18.275846,99.47753,5,GPS,,,Mueang Lampang District,"Mueang Lampang District, Lampang 52100",2026-02-27 09:32:24
Nat iPhone12mini,iPhone 12 mini,61,NotCharging,18.223882,99.515192,10,GPS,,,Mueang Lampang District,"Mueang Lampang District, Lampang 52000",2026-02-27 09:37:48
Nat iPhone12mini,iPhone 12 mini,58,NotCharging,18.240787,99.596923,5,GPS,,,Mueang Lampang District,"Mueang Lampang District, Lampang 52000",2026-02-27 09:48:13
Nat iPhone12mini,iPhone 12 mini,57,NotCharging,18.256232,99.655373,14,GPS,,,Mae Mo District,"84 Moo 5, Mae Mo, Mae Mo District, Lampang 52220",2026-02-27 09:53:39
Nat iPhone12mini,iPhone 12 mini,55,NotCharging,18.264667,99.709782,5,GPS,,,Mae Mo District,"62 Soi Pracha Rat, Mae Mo, Mae Mo District, Lampang 52220",2026-02-27 09:58:27
Nat iPhone12mini,iPhone 12 mini,54,NotCharging,18.277847,99.801018,8,GPS,,,Mae Mo District,"Mae Mo District, Lampang 52220",2026-02-27 10:06:25
Nat iPhone12mini,iPhone 12 mini,49,NotCharging,18.211666,99.871989,5,GPS,,,Long District,"76 Rural Highway 4003, Ban Pin, Long District, Phrae 54150",2026-02-27 10:29:32
Nat iPhone12mini,iPhone 12 mini,48,NotCharging,18.194947,99.870168,26,GPS,,,Long District,"Long District, Phrae 54150",2026-02-27 10:32:30
Nat iPhone12mini,iPhone 12 mini,46,NotCharging,18.096358,99.866883,2,GPS,,,Long District,"203 Thetsaban 2 Road, Ban Pin, Long District, Phrae 54150",2026-02-27 10:49:41
Nat iPhone12mini,iPhone 12 mini,45,NotCharging,18.096305,99.866846,9,GPS,,,Long District,"203 Thetsaban 2 Road, Ban Pin, Long District, Phrae 54150",2026-02-27 10:55:13
Nat iPhone12mini,iPhone 12 mini,44,NotCharging,18.080372,99.879712,16,GPS,,,Long District,"Long District, Phrae 54150",2026-02-27 10:59:32
Nat iPhone12mini,iPhone 12 mini,42,NotCharging,18.040347,99.916938,60,GPS,,,Long District,"Long District, Phrae 54150",2026-02-27 11:09:52
Nat iPhone12mini,iPhone 12 mini,41,NotCharging,18.032004,99.922519,36,GPS,,,Long District,"Long District, Phrae 54150",2026-02-27 11:11:34
Nat iPhone12mini,iPhone 12 mini,38,NotCharging,17.97274,100.052057,14,GPS,,,Den Chai District,"Den Chai District, Phrae 54110",2026-02-27 11:31:00
Nat iPhone12mini,iPhone 12 mini,36,NotCharging,17.92115,100.062211,10,GPS,,,Den Chai District,"Den Chai District, Phrae 54110",2026-02-27 11:36:34
Nat iPhone12mini,iPhone 12 mini,35,NotCharging,17.881632,100.040743,6,GPS,,,Den Chai District,"Den Chai District, Phrae 54110",2026-02-27 11:41:39
Nat iPhone12mini,iPhone 12 mini,34,NotCharging,17.839016,100.046134,14,GPS,,,Mueang Uttaradit District,"Mueang Uttaradit District, Uttaradit 53000",2026-02-27 11:47:01
Nat iPhone12mini,iPhone 12 mini,33,NotCharging,17.808954,100.066603,5,GPS,,,Mueang Uttaradit District,"Mueang Uttaradit District, Uttaradit 53000",2026-02-27 11:51:54
Nat iPhone12mini,iPhone 12 mini,32,NotCharging,17.77201,100.108,5,GPS,,,Mueang Uttaradit District,"169 Ro Pho Cho. Uttaradit 4013 Road, Ban Dan Na Kham, Mueang Uttaradit District, Uttaradit 53000",2026-02-27 11:57:12
Nat iPhone12mini,iPhone 12 mini,31,NotCharging,17.723428,100.126752,14,GPS,,,Mueang Uttaradit District,"33-99 Thanon Phatthanakan Soi 13, Ban Dan Na Kham, Mueang Uttaradit District, Uttaradit 53000",2026-02-27 12:02:22
Nat iPhone12mini,iPhone 12 mini,30,NotCharging,17.652857,100.122463,5,GPS,,,Mueang Uttaradit District,"Pracha Ruam Chai Road, Tha Sao, Mueang Uttaradit District, Uttaradit 53000",2026-02-27 12:07:28
Nat iPhone12mini,iPhone 12 mini,28,NotCharging,17.620929,100.097137,14,GPS,,,Mueang Uttaradit District,"1/47 Boromma At Road, Tha It, Mueang Uttaradit District, Uttaradit 53000",2026-02-27 12:17:39
Nat iPhone12mini,iPhone 12 mini,27,NotCharging,17.594402,100.093817,6,GPS,,,Mueang Uttaradit District,"242 Ban Nong Khan Road, Ban Ko, Mueang Uttaradit District, Uttaradit 53000",2026-02-27 12:23:17
Nat iPhone12mini,iPhone 12 mini,1,Charging,16.817458,100.25806,60,GPS,,,Mueang Phitsanulok District,"Phibun Songkhram Rajabhat University, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 16:23:02
Nat iPhone12mini,iPhone 12 mini,1,Charging,16.816864,100.258006,10,GPS,,,Mueang Phitsanulok District,"Pibulsongkram Rajabhat University, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 16:28:33
Nat iPhone12mini,iPhone 12 mini,4,Charging,16.81687,100.258008,10,unknown,,,Mueang Phitsanulok District,"Pibulsongkram Rajabhat University, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 16:43:35
Nat iPhone12mini,iPhone 12 mini,11,Charging,16.816871,100.258008,10,unknown,,,Mueang Phitsanulok District,"Pibulsongkram Rajabhat University, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 16:49:04
Nat iPhone12mini,iPhone 12 mini,15,Charging,16.816907,100.258004,10,GPS,,,Mueang Phitsanulok District,"Pibulsongkram Rajabhat University, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 16:53:51
Nat iPhone12mini,iPhone 12 mini,40,Charging,16.816956,100.258004,10,unknown,,,Mueang Phitsanulok District,"Pibulsongkram Rajabhat University, 66 Wang Chan Road, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 17:30:17
Nat iPhone12mini,iPhone 12 mini,45,NotCharging,16.81693,100.258031,15,GPS,,,Mueang Phitsanulok District,"Pibulsongkram Rajabhat University, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 17:50:55
Nat iPhone12mini,iPhone 12 mini,43,NotCharging,16.817666,100.258349,8,GPS,,,Mueang Phitsanulok District,"66 Wang Chan Road, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 17:55:38
Nat iPhone12mini,iPhone 12 mini,1,NotCharging,16.818115,100.258121,4,GPS,,,Mueang Phitsanulok District,"66 Wang Chan Road, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 18:07:27
Nat iPhone12mini,iPhone 12 mini,1,NotCharging,16.817928,100.25823,4,GPS,,,Mueang Phitsanulok District,"66 Wang Chan Road, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 18:17:22
Nat iPhone12mini,iPhone 12 mini,1,NotCharging,16.816055,100.256881,4,GPS,,,Mueang Phitsanulok District,"80/71 Pracha Uthit Road, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 18:22:35
Nat iPhone12mini,iPhone 12 mini,1,NotCharging,16.813947,100.263612,8,GPS,,,Mueang Phitsanulok District,"30 Chaophraya Road, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 18:27:44
Nat iPhone12mini,iPhone 12 mini,1,NotCharging,16.813897,100.263608,5,GPS,,,Mueang Phitsanulok District,"30 Chaophraya Road, Nai Mueang, Mueang Phitsanulok District, Phitsanulok 65000",2026-02-27 18:33:01`;

        // ----------------------------------------------------
        // 1. Scene Setup
        // ----------------------------------------------------
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb); // Bright Sky Blue

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 2500);
        camera.position.set(100, 120, 200);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.maxPolarAngle = Math.PI / 1.5; // Allow looking up more

        // Lights
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(100, 400, 100);
        scene.add(sun);

        // Ground (Grass)
        const ground = new THREE.Mesh(
            new THREE.PlaneGeometry(3000, 3000),
            new THREE.MeshPhongMaterial({ color: 0x4caf50 })
        );
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -0.1;
        scene.add(ground);

        // ----------------------------------------------------
        // 2. Data Parsing & Altitude
        // ----------------------------------------------------
        function getCSVRows(text) {
            const rows = [];
            const lines = text.trim().split('\n');
            for (let line of lines) {
                const cells = [];
                let cell = '';
                let quotes = false;
                for (let char of line) {
                    if (char === '"') quotes = !quotes;
                    else if (char === ',' && !quotes) {
                        cells.push(cell.trim());
                        cell = '';
                    } else cell += char;
                }
                cells.push(cell.trim());
                rows.push(cells);
            }
            return rows;
        }

        const rawRows = getCSVRows(csvData);
        const waypoints = [];
        const centerLat = 17.6; const centerLon = 99.6; const scale = 800;
        const altitude = 40; // ‚úàÔ∏è Fly high!

        for (let i = 1; i < rawRows.length; i++) {
            const row = rawRows[i];
            const lat = parseFloat(row[4]);
            const lon = parseFloat(row[5]);
            if (!isNaN(lat) && !isNaN(lon)) {
                waypoints.push({
                    x: (lon - centerLon) * scale,
                    y: altitude,
                    z: -(lat - centerLat) * scale,
                    meta: {
                        battery: row[2],
                        address: row[11]?.replace(/"/g, '') || row[10],
                        locality: row[10],
                        time: row[12]
                    }
                });
            }
        }

        // ----------------------------------------------------
        // 3. Sky Construction
        // ----------------------------------------------------

        // Flight Path (Invisible or subtle)
        const curve = new THREE.CatmullRomCurve3(waypoints.map(w => new THREE.Vector3(w.x, w.y, w.z)));
        const pathPoints = curve.getPoints(1000);
        const pathLine = new THREE.Line(new THREE.BufferGeometry().setFromPoints(pathPoints), new THREE.LineBasicMaterial({ color: 0xffffff, opacity: 0.2, transparent: true }));
        scene.add(pathLine);

        // Clouds ‚òÅÔ∏è
        const cloudGeo = new THREE.SphereGeometry(10, 8, 8);
        const cloudMat = new THREE.MeshPhongMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 });
        for (let i = 0; i < 40; i++) {
            const cloud = new THREE.Group();
            for (let j = 0; j < 3; j++) {
                const s = new THREE.Mesh(cloudGeo, cloudMat);
                s.position.set(j * 8, Math.random() * 5, Math.random() * 5);
                s.scale.set(1 + Math.random(), 0.6, 0.8);
                cloud.add(s);
            }
            cloud.position.set((Math.random() - 0.5) * 1500, altitude + (Math.random() - 0.5) * 30, (Math.random() - 0.5) * 1500);
            scene.add(cloud);
        }

        // Trees & Mountains (On the ground)
        const treeGeo = new THREE.ConeGeometry(1.5, 5, 8);
        const treeMat = new THREE.MeshPhongMaterial({ color: 0x1b5e20 });
        for (let i = 0; i < 600; i++) {
            const t = new THREE.Mesh(treeGeo, treeMat);
            t.position.set((Math.random() - 0.5) * 1500, 2.5, (Math.random() - 0.5) * 1500);
            scene.add(t);
        }

        // --- ‚úàÔ∏è Airplane Model ---
        const airplane = new THREE.Group();

        // Body
        const body = new THREE.Mesh(new THREE.CapsuleGeometry(1.5, 6, 4, 16), new THREE.MeshPhongMaterial({ color: 0xffffff }));
        body.rotation.x = Math.PI / 2;
        airplane.add(body);

        // Wings
        const wing = new THREE.Mesh(new THREE.BoxGeometry(10, 0.2, 2.5), new THREE.MeshPhongMaterial({ color: 0xffffff }));
        wing.position.set(0, 0, 0);
        airplane.add(wing);

        // Tail
        const tailHoriz = new THREE.Mesh(new THREE.BoxGeometry(4, 0.1, 1.5), new THREE.MeshPhongMaterial({ color: 0xffffff }));
        tailHoriz.position.set(0, 0, -3.5);
        airplane.add(tailHoriz);

        const tailVert = new THREE.Mesh(new THREE.BoxGeometry(0.1, 2, 1.5), new THREE.MeshPhongMaterial({ color: 0xd32f2f })); // Red tail
        tailVert.position.set(0, 1, -3.5);
        airplane.add(tailVert);

        // Propeller
        const prop = new THREE.Mesh(new THREE.BoxGeometry(4, 0.2, 0.2), new THREE.MeshPhongMaterial({ color: 0x333333 }));
        prop.position.set(0, 0, 3.5);
        airplane.add(prop);

        scene.add(airplane);

        // ----------------------------------------------------
        // 4. Animation Engine
        // ----------------------------------------------------
        let progress = 0;
        function animate() {
            requestAnimationFrame(animate);
            progress += 0.0001; // Slower, more majestic flight
            if (progress > 1) progress = 0;

            const pos = curve.getPointAt(progress);
            airplane.position.copy(pos);
            airplane.lookAt(curve.getPointAt(Math.min(progress + 0.005, 1)));

            // Spin propeller
            prop.rotation.z += 0.5;

            // Bank slightly on turns
            const tangent = curve.getTangentAt(progress);
            airplane.rotation.z = -tangent.x * 2;

            const idx = Math.floor(progress * (waypoints.length - 1));
            const wp = waypoints[idx].meta;
            document.getElementById('place').innerText = wp.locality || '‡∏™‡∏ô‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏ô';
            document.getElementById('address').innerText = wp.address;
            document.getElementById('time').innerText = wp.time;
            document.getElementById('battery').innerText = wp.battery + '%';

            controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('load', () => {
            document.getElementById('loading').style.display = 'none';
            animate();
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>

</html>